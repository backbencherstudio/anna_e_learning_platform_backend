<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Upload with Progress</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 40px;
        max-width: 600px;
        width: 100%;
      }

      h1 {
        color: #333;
        margin-bottom: 30px;
        text-align: center;
        font-size: 24px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
      }

      input[type='text'],
      input[type='file'],
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input[type='text']:focus,
      input[type='file']:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .progress-section {
        display: none;
        margin-top: 30px;
        padding-top: 30px;
        border-top: 2px solid #e0e0e0;
      }

      .progress-section.active {
        display: block;
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 14px;
        color: #666;
      }

      .progress-bar-container {
        background: #f0f0f0;
        border-radius: 8px;
        height: 8px;
        overflow: hidden;
        margin-bottom: 15px;
      }

      .progress-bar {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
      }

      .status-message {
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 14px;
        text-align: center;
      }

      .status-message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status-message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .upload-id {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
        margin-top: 10px;
        font-size: 12px;
        word-break: break-all;
        color: #666;
      }

      .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
        font-size: 13px;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
      }

      .stat-label {
        color: #999;
        font-weight: 500;
      }

      .stat-value {
        color: #333;
        font-weight: 600;
        margin-top: 5px;
      }

      .emoji {
        margin-right: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1><span class="emoji">üìπ</span>Video Upload</h1>

      <form id="uploadForm">
        <div class="form-group">
          <label for="title">Lesson Title</label>
          <input
            type="text"
            id="title"
            placeholder="Enter lesson title"
            required
          />
        </div>

        <div class="form-group">
          <label for="courseId">Course ID</label>
          <input
            type="text"
            id="courseId"
            placeholder="Enter course ID"
            value="cmgyly7280007ws086d7t8f1b"
            required
          />
        </div>

        <div class="form-group">
          <label for="token">JWT Token</label>
          <input
            type="text"
            id="token"
            placeholder="Enter your JWT token"
            value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFkbWluQGdtYWlsLmNvbSIsInN1YiI6ImNtZ3lsdXJoaDAwMDB3czA4NTEzZmIzZmkiLCJpYXQiOjE3NjA5MzMxMDUsImV4cCI6MTc2MTAxOTUwNX0.FCKOxHKIB0admFLmlRuMfOB5Qo_A2hq0mm5iErs02HE"
            required
          />
        </div>

        <div class="form-group">
          <label for="videoFile">Select Video File</label>
          <input type="file" id="videoFile" accept="video/*" required />
        </div>

        <button type="submit">Upload Video</button>
      </form>

      <div class="progress-section" id="progressSection">
        <div class="progress-info">
          <span id="fileNameDisplay"></span>
          <span id="percentDisplay">0%</span>
        </div>

        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="stats">
          <div class="stat-item">
            <div class="stat-label"><span class="emoji">üì¶</span>Chunks</div>
            <div class="stat-value">
              <span id="chunksProgress">0</span>/<span id="totalChunks">0</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-label"><span class="emoji">üìä</span>Size</div>
            <div class="stat-value"><span id="fileSize">0</span> MB</div>
          </div>
        </div>

        <div class="status-message info" id="statusMessage"></div>
        <div class="upload-id" id="uploadIdDisplay"></div>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      const API_BASE = 'http://localhost:4000/api';
      const WS_URL = 'http://localhost:4000';

      let socket = null;
      let currentUploadId = null;
      let keepAliveInterval = null;
      let socketConnecting = false;

      // Initialize Socket.IO connection - keep persistent
      function initSocket() {
        if (socket && socket.connected) {
          console.log('‚ÑπÔ∏è Socket already connected:', socket.id);
          return socket;
        }

        if (socketConnecting) {
          console.log('‚ÑπÔ∏è Socket connection in progress...');
          return socket;
        }

        socketConnecting = true;
        socket = io(`${WS_URL}/chunk-upload`, {
          transports: ['websocket', 'polling'],
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          reconnectionAttempts: Infinity,
          forceNew: false,
        });

        socket.on('connect', () => {
          socketConnecting = false;
          console.log('‚úÖ Socket.IO connected:', socket.id);
        });

        socket.on('connect_error', (error) => {
          socketConnecting = false;
          console.error('‚ùå Socket.IO connection error:', error);
          showStatus(`‚ùå Connection error: ${error.message || error}`, 'error');
        });

        socket.on('disconnect', (reason) => {
          console.log('‚ö†Ô∏è Socket.IO disconnected, reason:', reason);
          // Try to reconnect if upload is in progress
          if (currentUploadId && reason !== 'io client namespace disconnect') {
            console.log('üîÑ Attempting to reconnect...');
            setTimeout(() => {
              if (!socket.connected) {
                socket.connect();
              }
            }, 2000);
          }
        });

        socket.on('pong', () => {
          console.log('üíì [SOCKET] Pong received - connection alive');
        });

        socket.on('upload-progress', (data) => {
          console.log('üìä [SOCKET] Progress Update:', {
            uploadId: data.uploadId,
            progress: data.progress + '%',
            chunks: data.uploadedChunks + '/' + data.totalChunks,
            fileName: data.fileName,
          });

          updateProgressUI(data);
        });

        socket.on('chunk-complete', (data) => {
          console.log(
            'üì¶ [SOCKET] Chunk Complete:',
            data.chunkIndex + 1 + '/' + data.totalChunks,
          );
        });

        socket.on('upload-complete', (data) => {
          console.log('‚úÖ [SOCKET] Upload Complete:', data.fileName);
          showStatus(`‚úÖ Upload completed! File: ${data.fileName}`, 'success');
          document.getElementById('progressBar').style.width = '100%';
          document.getElementById('percentDisplay').textContent = '100%';
          setTimeout(() => {
            resetForm();
          }, 2000);
        });

        socket.on('upload-error', (data) => {
          console.error('‚ùå [SOCKET] Upload Error:', data.error);
          showStatus(`‚ùå Error: ${data.error}`, 'error');
        });
      }

      // Update progress UI
      function updateProgressUI(data) {
        const percentage = data.progress;
        document.getElementById('progressBar').style.width = percentage + '%';
        document.getElementById('percentDisplay').textContent =
          percentage + '%';
        document.getElementById('fileNameDisplay').textContent = data.fileName;
        document.getElementById('chunksProgress').textContent =
          data.uploadedChunks;
        document.getElementById('totalChunks').textContent = data.totalChunks;
        document.getElementById('fileSize').textContent = (
          data.fileSize /
          1024 /
          1024
        ).toFixed(2);
      }

      // Show status message
      function showStatus(message, type = 'info') {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = message;
        statusEl.className = `status-message ${type}`;
      }

      // Reset form
      function resetForm() {
        document.getElementById('uploadForm').reset();
        document.getElementById('progressSection').classList.remove('active');
        currentUploadId = null;

        // Cleanup keep-alive interval
        if (keepAliveInterval) {
          clearInterval(keepAliveInterval);
          keepAliveInterval = null;
        }
      }

      // Handle form submission
      document
        .getElementById('uploadForm')
        .addEventListener('submit', async (e) => {
          e.preventDefault();

          const title = document.getElementById('title').value;
          const courseId = document.getElementById('courseId').value;
          const token = document.getElementById('token').value;
          const videoFile = document.getElementById('videoFile').files[0];

          if (!videoFile) {
            showStatus('‚ùå Please select a video file', 'error');
            return;
          }

          // Show progress section
          document.getElementById('progressSection').classList.add('active');
          showStatus('üöÄ Starting upload...', 'info');

          // Initialize socket
          initSocket();

          // Prepare form data
          const formData = new FormData();
          formData.append('title', title);
          formData.append('course_id', courseId);
          formData.append('videoFile', videoFile);

          try {
            // Upload file
            const response = await fetch(
              `${API_BASE}/admin/series/lesson-file`,
              {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                body: formData,
              },
            );

            const data = await response.json();

            if (data.success) {
              console.log('‚úÖ [API] Response:', data);

              if (data.data.uploadId) {
                currentUploadId = data.data.uploadId;
                console.log('üìç Upload ID:', currentUploadId);
                document.getElementById('uploadIdDisplay').textContent =
                  `üìç Upload ID: ${currentUploadId}`;

                // Join socket room for this upload
                socket.emit('join-upload', { uploadId: currentUploadId });

                // Keep socket alive during upload
                if (keepAliveInterval) clearInterval(keepAliveInterval);
                keepAliveInterval = setInterval(() => {
                  if (socket && socket.connected) {
                    socket.emit('ping', {});
                  }
                }, 5000);

                showStatus(
                  '‚è≥ Uploading in background... (watch Socket.IO events in console)',
                  'info',
                );
              } else {
                showStatus('‚úÖ ' + data.message, 'success');
                document.getElementById('uploadIdDisplay').textContent = '';
              }
            } else {
              showStatus('‚ùå ' + data.message, 'error');
            }
          } catch (error) {
            console.error('‚ùå [ERROR]:', error);
            showStatus('‚ùå Upload failed: ' + error.message, 'error');
          }
        });

      // Log all events in console for debugging
      console.log(
        '%cüìπ Video Upload Progress Tracker',
        'font-size: 16px; font-weight: bold; color: #667eea;',
      );
      console.log(
        '%cWatch the console for Socket.IO events!',
        'color: #764ba2; font-size: 12px;',
      );
    </script>
  </body>
</html>
